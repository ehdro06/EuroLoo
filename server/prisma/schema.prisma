generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Toilet {
  id           Int      @id @default(autoincrement())
  externalId   String   @unique
  lat          Float
  lon          Float
  name         String?
  operator     String?
  fee          String?
  isFree       Boolean  @default(false)
  isPaid       Boolean  @default(false)
  openingHours String?
  wheelchair   String?
  isAccessible Boolean  @default(false) // Derived from wheelchair tag usually
  isUserCreated Boolean @default(false)

  // specific PostGIS geography column
  location     Unsupported("geometry(Point, 4326)")?

  // Data Integrity / Crowd Control
  reportCount  Int      @default(0)
  verifyCount  Int      @default(0)
  isVerified   Boolean  @default(false)
  isHidden     Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt // Track when we last synced or updated
  reviews      Review[]
  
  // User Identity
  contributorId Int?
  contributor   User?   @relation(fields: [contributorId], references: [id])
  votes         Vote[]

  @@index([lat, lon])
}

model Review {
  id        Int      @id @default(autoincrement())
  content   String
  rating    Int
  createdAt DateTime @default(now())
  toiletId  Int
  toilet    Toilet   @relation(fields: [toiletId], references: [id], onDelete: Cascade)
  authorId  Int?
  author    User?    @relation(fields: [authorId], references: [id])
}

model User {
  id           Int      @id @default(autoincrement())
  clerkId      String   @unique
  email        String?  @unique
  username     String?
  role         String   @default("USER") // USER, ADMIN
  reputation   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  reviews      Review[]
  createdToilets Toilet[]
  votes        Vote[]
}

model Vote {
  id        Int      @id @default(autoincrement())
  type      String   // "VERIFY", "REPORT"
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  toiletId  Int
  toilet    Toilet   @relation(fields: [toiletId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, toiletId, type])
}
